name: Deploy examples
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      example:
        description: the desired example (all for all examples)
        type: choice
        options:
          - default
          - all




jobs:
  init:
    name: Initialize global clusters variables
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: benjlevesque/short-sha@v2.2
        id: short-sha
        with:
          length: 6
    outputs:
      short-sha: ${{ steps.short-sha.outputs.sha }}

  default:
    needs: init
    name: Default cluster for ${{ needs.init.outputs.short-sha }}
    if: contains(fromJson('["all", "default"]'), inputs.example) || ${{ github.ref == 'refs/heads/main' }}
    uses: ./.github/workflows/reuse-test-clusters.yaml
    with:
      pulumi-stack: default-${{ needs.init.outputs.short-sha }}
      pulumi-config-source: examples/default.yaml
    secrets:
      google-credentials: ${{ secrets.GOOGLE_CREDENTIALS }}
      hcloud-token: ${{ secrets.HCLOUD_TOKEN }}
